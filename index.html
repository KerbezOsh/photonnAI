<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>photonnAI ‚Äî Lunar Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0b0f;
            --bg-secondary: #050507;
            --bg-tertiary: #111318;
            --bg-sidebar: #08090c;
            --bg-card: #0d0e13;
            --bg-hover: #151720;
            --bg-input: #0d0e13;
            --accent-primary: #a78bfa;
            --accent-secondary: #c4b5fd;
            --accent-gradient: linear-gradient(135deg, #a78bfa 0%, #818cf8 50%, #6366f1 100%);
            --accent-light: rgba(167, 139, 250, 0.12);
            --accent-glow: rgba(167, 139, 250, 0.25);
            --text-primary: #e8eaed;
            --text-secondary: #8b8fa3;
            --text-muted: #555869;
            --text-inverse: #0f0f14;
            --border: #1a1d28;
            --border-light: #252838;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.5);
            --shadow-md: 0 4px 15px rgba(0, 0, 0, 0.6);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.7);
            --shadow-glow: 0 0 30px rgba(167, 139, 250, 0.15);
            --success: #34d399;
            --error: #f87171;
            --warning: #fbbf24;
            --radius: 14px;
            --radius-sm: 10px;
            --radius-lg: 20px;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        #app {
            height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            min-width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: 0;
            min-width: 0;
            padding: 0;
            border: none;
        }

        /* Logo */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 4px 16px;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: var(--accent-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-glow), var(--shadow-md);
            flex-shrink: 0;
        }

        .logo-text {
            font-size: 1.4rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
        }

        /* New Chat Button */
        .new-chat-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--accent-gradient);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-inverse);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: var(--shadow-md), var(--shadow-glow);
            white-space: nowrap;
        }

        .new-chat-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-lg), 0 0 35px rgba(167, 139, 250, 0.4);
        }

        .new-chat-btn:active {
            transform: scale(0.96);
        }

        /* Chat List */
        .chat-list-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow-y: auto;
            margin: 8px 0;
        }

        .chat-list-section::-webkit-scrollbar {
            width: 4px;
        }

        .chat-list-section::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        .section-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            padding: 8px 8px 4px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
        }

        .chat-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .chat-item.active {
            background: var(--accent-light);
            color: var(--accent-primary);
            border-color: rgba(167, 139, 250, 0.3);
        }

        .chat-item-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .chat-item-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-item-delete {
            opacity: 0;
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            padding: 4px;
            font-size: 0.9rem;
            transition: opacity 0.2s;
        }

        .chat-item:hover .chat-item-delete {
            opacity: 1;
        }

        .chat-item-delete:hover {
            transform: scale(1.2);
        }

        /* Nav Buttons */
        .nav-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
            border-top: 1px solid var(--border);
            padding-top: 12px;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-btn:active {
            transform: scale(0.97);
        }

        .nav-icon {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        /* Language Selector */
        .lang-selector {
            position: relative;
        }

        .lang-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .lang-btn:hover {
            border-color: var(--accent-primary);
        }

        .lang-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            max-height: 240px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.25s ease;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .lang-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .lang-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.15s ease;
            font-size: 0.85rem;
        }

        .lang-option:hover {
            background: var(--bg-hover);
        }

        .lang-option.active {
            background: var(--accent-light);
            color: var(--accent-primary);
        }

        /* Model Selector */
        .model-selector {
            position: relative;
            margin-bottom: 8px;
        }

        .model-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .model-btn:hover {
            border-color: var(--accent-primary);
        }

        .model-btn-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            max-height: 280px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.25s ease;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .model-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .model-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.15s ease;
            border-bottom: 1px solid var(--border);
        }

        .model-option:last-child {
            border-bottom: none;
        }

        .model-option:hover {
            background: var(--bg-hover);
        }

        .model-option.active {
            background: var(--accent-light);
        }

        .model-option-icon {
            font-size: 1.2rem;
            width: 28px;
            text-align: center;
        }

        .model-option-info {
            flex: 1;
        }

        .model-option-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .model-option.active .model-option-name {
            color: var(--accent-primary);
        }

        .model-option-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .model-option-check {
            color: var(--accent-primary);
            font-size: 1rem;
            opacity: 0;
        }

        .model-option.active .model-option-check {
            opacity: 1;
        }

        /* Status Panel */
        .status-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.75rem;
        }

        .status-label {
            color: var(--text-muted);
        }

        .status-value {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .status-dot.offline {
            background: var(--error);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
        }

        /* Chat Header */
        .chat-header {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
        }

        .sidebar-toggle {
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .sidebar-toggle:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
        }

        .chat-title {
            flex: 1;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-badge {
            background: var(--accent-light);
            border: 1px solid rgba(167, 139, 250, 0.3);
            padding: 5px 10px;
            border-radius: 16px;
            font-size: 0.7rem;
            color: var(--accent-primary);
            font-weight: 500;
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        }

        .messages-container::-webkit-scrollbar {
            width: 5px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 16px;
            padding: 40px;
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            animation: floatMoon 4s ease-in-out infinite;
        }

        @keyframes floatMoon {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .empty-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .empty-subtitle {
            color: var(--text-secondary);
            max-width: 400px;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            max-width: 500px;
        }

        .suggestion-chip {
            padding: 8px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-chip:hover {
            background: var(--accent-light);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: translateY(-2px);
        }

        /* Messages */
        .message {
            display: flex;
            gap: 12px;
            max-width: 800px;
            animation: messageIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            opacity: 0;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--accent-gradient);
            box-shadow: var(--shadow-glow);
        }

        .message.assistant .message-avatar {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        .message-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .message-name {
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .message-time {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: var(--radius);
            line-height: 1.6;
            font-size: 0.88rem;
        }

        .message.user .message-bubble {
            background: var(--accent-gradient);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: var(--shadow-md), var(--shadow-glow);
        }

        .message.assistant .message-bubble {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
            color: var(--text-primary);
        }

        .message-actions {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .msg-action-btn {
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .msg-action-btn:hover {
            background: var(--accent-light);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        /* Typing Indicator - –ö—Ä–∞—Å–∏–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è "–¥—É–º–∞–µ—Ç" */
        .typing-indicator {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            max-width: 800px;
            animation: messageIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .typing-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--accent-gradient);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            box-shadow: var(--shadow-glow);
            animation: avatarPulse 2s ease-in-out infinite;
        }

        @keyframes avatarPulse {
            0%, 100% { transform: scale(1); box-shadow: var(--shadow-glow); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(167, 139, 250, 0.5); }
        }

        .typing-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .typing-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .typing-name {
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .typing-status {
            font-size: 0.7rem;
            color: var(--accent-primary);
            animation: statusBlink 1.5s ease-in-out infinite;
        }

        @keyframes statusBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .typing-bubble {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 18px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            border-bottom-left-radius: 4px;
        }

        .typing-dots {
            display: flex;
            gap: 5px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
            box-shadow: 0 0 6px var(--accent-primary);
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        .typing-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .thinking-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Composer */
        .composer {
            padding: 16px 20px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
        }

        .composer-inner {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 4px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-glow);
        }

        .input-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .message-input {
            flex: 1;
            padding: 10px 12px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            resize: none;
            outline: none;
            min-height: 24px;
            max-height: 120px;
            line-height: 1.5;
        }

        .message-input::placeholder {
            color: var(--text-muted);
        }

        .attach-btn {
            width: 36px;
            height: 36px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .attach-btn:hover {
            background: var(--accent-light);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .attach-btn.has-image {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .image-preview {
            display: none;
            padding: 8px;
            border-top: 1px solid var(--border);
        }

        .image-preview.active {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid var(--accent-primary);
        }

        .preview-info {
            flex: 1;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .preview-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .preview-remove {
            width: 28px;
            height: 28px;
            background: var(--error);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .preview-remove:hover {
            transform: scale(1.1);
        }

        .send-btn {
            width: 48px;
            height: 48px;
            background: var(--accent-gradient);
            border: none;
            border-radius: var(--radius);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: var(--shadow-md), var(--shadow-glow);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: translateY(-2px) scale(1.05);
        }

        .send-btn:active {
            transform: scale(0.92);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Image in message */
        .message-image {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-image:hover {
            transform: scale(1.02);
        }

        /* Image modal */
        .image-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            cursor: zoom-out;
        }

        .image-modal img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 8px;
        }

        #file-input {
            display: none;
        }

        /* Code Blocks */
        .code-block-wrapper {
            position: relative;
            margin: 10px 0;
            border-radius: var(--radius-sm);
            overflow: hidden;
            background: #0d1117;
            border: 1px solid var(--border);
        }

        .code-block-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            background: #161b22;
            border-bottom: 1px solid var(--border);
        }

        .code-language {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent-primary);
            font-weight: 600;
            text-transform: uppercase;
        }

        .code-copy-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--accent-light);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 5px;
            color: var(--accent-primary);
            font-family: inherit;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .code-copy-btn:hover {
            background: var(--accent-primary);
            color: white;
        }

        .code-copy-btn.copied {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .code-block-content {
            padding: 14px;
            overflow-x: auto;
        }

        .code-block-content pre {
            margin: 0;
            padding: 0;
            background: transparent;
            border: none;
            color: #e6edf3;
        }

        .code-block-content code {
            background: transparent;
            padding: 0;
            color: #e6edf3;
            font-size: 0.8rem;
            line-height: 1.5;
            font-family: 'JetBrains Mono', monospace;
        }

        .inline-code {
            font-family: 'JetBrains Mono', monospace;
            background: rgba(167, 139, 250, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.82em;
            color: var(--accent-secondary);
            border: 1px solid rgba(167, 139, 250, 0.2);
        }

        .token-keyword { color: #ff7b72; }
        .token-string { color: #a5d6ff; }
        .token-comment { color: #8b949e; font-style: italic; }
        .token-function { color: #d2a8ff; }
        .token-number { color: #79c0ff; }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 9999;
            pointer-events: none;
        }

        .toast {
            padding: 12px 18px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.85rem;
            box-shadow: var(--shadow-lg);
            pointer-events: auto;
            animation: toastIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .toast.error { border-color: var(--error); background: rgba(248, 113, 113, 0.15); color: var(--error); }
        .toast.success { border-color: var(--success); background: rgba(52, 211, 153, 0.15); color: var(--success); }
        .toast.warning { border-color: var(--warning); background: rgba(251, 191, 36, 0.15); color: var(--warning); }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .toast-exit {
            animation: toastOut 0.3s ease forwards;
        }

        @keyframes toastOut {
            to { opacity: 0; transform: translateX(100px); }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            animation: fadeIn 0.2s ease;
            backdrop-filter: blur(8px);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 28px;
            max-width: 420px;
            width: 90%;
            animation: modalIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            box-shadow: var(--shadow-lg);
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 18px;
        }

        .modal-logo {
            width: 50px;
            height: 50px;
            background: var(--accent-gradient);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            box-shadow: var(--shadow-glow);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .modal-body {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .modal-close-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-gradient);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-close-btn:hover {
            transform: scale(1.02);
        }

        /* Confetti */
        #confetti-canvas {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 9999;
            display: none;
        }

        .shake-effect {
            animation: shakeIt 0.5s ease;
        }

        @keyframes shakeIt {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 100;
                transform: translateX(-100%);
            }

            .sidebar:not(.collapsed) {
                transform: translateX(0);
                box-shadow: var(--shadow-lg);
            }

            .sidebar.collapsed {
                transform: translateX(-100%);
            }

            .sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 99;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }

            .sidebar-overlay.open {
                opacity: 1;
                visibility: visible;
            }

            .messages-container {
                padding: 16px;
            }

            .empty-icon {
                width: 60px;
                height: 60px;
                font-size: 2rem;
            }

            .empty-title {
                font-size: 1.2rem;
            }

            .suggestions {
                flex-direction: column;
                align-items: center;
            }

            .composer {
                padding: 12px 16px;
            }
        }

        @media (min-width: 769px) {
            .sidebar-overlay {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <canvas id="confetti-canvas"></canvas>
    <div id="app"></div>
    
    <script>
// ============ TRANSLATIONS ============
const translations = {
    en: {
        newChat: 'New Chat',
        chats: 'Chats',
        today: 'Today',
        clear: 'Clear All',
        about: 'About',
        language: 'Language',
        status: 'Status',
        online: 'Online',
        offline: 'Offline',
        model: 'Model',
        selectModel: 'Select Model',
        modelAuto: 'Auto (Smart)',
        modelAutoDesc: 'Auto-select based on task',
        messages: 'Messages',
        placeholder: 'Ask photonnAI anything...',
        copy: 'Copy',
        copied: 'Copied!',
        emptyTitle: 'Hello, I\'m photonnAI',
        emptySubtitle: 'Your intelligent lunar AI assistant. Ask me anything ‚Äî code, ideas, writing, analysis, and more.',
        suggestion1: '‚ú® Explain quantum computing',
        suggestion2: 'üöÄ Write Python code',
        suggestion3: 'üé® Help design a logo',
        suggestion4: 'üìù Improve my resume',
        you: 'You',
        assistant: 'photonnAI',
        aboutTitle: 'About photonnAI',
        aboutText: 'photonnAI is an advanced lunar AI assistant powered by cutting-edge language models. Built with ‚ù§Ô∏è for curious minds.',
        close: 'Close',
        error: 'Connection error. Please try again.',
        cleared: 'All chats cleared',
        deleteChat: 'Chat deleted',
        untitled: 'New conversation'
    },
    ru: {
        newChat: '–ù–æ–≤—ã–π —á–∞—Ç',
        chats: '–ß–∞—Ç—ã',
        today: '–°–µ–≥–æ–¥–Ω—è',
        clear: '–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë',
        about: '–û –ø—Ä–æ–µ–∫—Ç–µ',
        language: '–Ø–∑—ã–∫',
        status: '–°—Ç–∞—Ç—É—Å',
        online: '–û–Ω–ª–∞–π–Ω',
        offline: '–û—Ñ—Ñ–ª–∞–π–Ω',
        model: '–ú–æ–¥–µ–ª—å',
        selectModel: '–í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏',
        modelAuto: '–ê–≤—Ç–æ (–£–º–Ω—ã–π)',
        modelAutoDesc: '–ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–æ –∑–∞–¥–∞—á–µ',
        messages: '–°–æ–æ–±—â–µ–Ω–∏–π',
        placeholder: '–°–ø—Ä–æ—Å–∏—Ç–µ photonnAI —á—Ç–æ —É–≥–æ–¥–Ω–æ...',
        copy: '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å',
        copied: '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!',
        emptyTitle: '–ü—Ä–∏–≤–µ—Ç, —è photonnAI',
        emptySubtitle: '–í–∞—à –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ª—É–Ω–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ü–æ–º–æ–≥—É —Å –∫–æ–¥–æ–º, –∏–¥–µ—è–º–∏, —Ç–µ–∫—Å—Ç–∞–º–∏ –∏ –∞–Ω–∞–ª–∏–∑–æ–º.',
        suggestion1: '‚ú® –û–±—ä—è—Å–Ω–∏ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã',
        suggestion2: 'üöÄ –ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python',
        suggestion3: 'üé® –ü–æ–º–æ–≥–∏ –ø—Ä–∏–¥—É–º–∞—Ç—å –ª–æ–≥–æ—Ç–∏–ø',
        suggestion4: 'üìù –£–ª—É—á—à–∏ –º–æ—ë —Ä–µ–∑—é–º–µ',
        you: '–í—ã',
        assistant: 'photonnAI',
        aboutTitle: '–û photonnAI',
        aboutText: 'photonnAI ‚Äî –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ª—É–Ω–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ –±–∞–∑–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π. –°–æ–∑–¥–∞–Ω —Å ‚ù§Ô∏è.',
        close: '–ó–∞–∫—Ä—ã—Ç—å',
        error: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.',
        cleared: '–í—Å–µ —á–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã',
        deleteChat: '–ß–∞—Ç —É–¥–∞–ª—ë–Ω',
        untitled: '–ù–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä'
    },
    es: {
        newChat: 'Nuevo chat', chats: 'Chats', today: 'Hoy', clear: 'Borrar todo', about: 'Acerca de',
        language: 'Idioma', status: 'Estado', online: 'En l√≠nea', offline: 'Desconectado', model: 'Modelo',
        messages: 'Mensajes', placeholder: 'Pregunta a photonnAI...', copy: 'Copiar', copied: '¬°Copiado!',
        emptyTitle: 'Hola, soy photonnAI', emptySubtitle: 'Tu asistente IA lunar inteligente.',
        suggestion1: '‚ú® Explica computaci√≥n cu√°ntica', suggestion2: 'üöÄ Escribe c√≥digo Python',
        suggestion3: 'üé® Ayuda a dise√±ar un logo', suggestion4: 'üìù Mejora mi curr√≠culum',
        you: 'T√∫', assistant: 'photonnAI', aboutTitle: 'Sobre photonnAI',
        aboutText: 'photonnAI es un asistente IA lunar avanzado.', close: 'Cerrar',
        error: 'Error de conexi√≥n.', cleared: 'Chats borrados', deleteChat: 'Chat eliminado', untitled: 'Nueva conversaci√≥n'
    },
    de: {
        newChat: 'Neuer Chat', chats: 'Chats', today: 'Heute', clear: 'Alles l√∂schen', about: '√úber',
        language: 'Sprache', status: 'Status', online: 'Online', offline: 'Offline', model: 'Modell',
        messages: 'Nachrichten', placeholder: 'Frag photonnAI...', copy: 'Kopieren', copied: 'Kopiert!',
        emptyTitle: 'Hallo, ich bin photonnAI', emptySubtitle: 'Dein intelligenter Mond-KI-Assistent.',
        suggestion1: '‚ú® Erkl√§re Quantencomputer', suggestion2: 'üöÄ Schreibe Python-Code',
        suggestion3: 'üé® Hilf beim Logo-Design', suggestion4: 'üìù Verbessere meinen Lebenslauf',
        you: 'Du', assistant: 'photonnAI', aboutTitle: '√úber photonnAI',
        aboutText: 'photonnAI ist ein fortschrittlicher Mond-KI-Assistent.', close: 'Schlie√üen',
        error: 'Verbindungsfehler.', cleared: 'Alle Chats gel√∂scht', deleteChat: 'Chat gel√∂scht', untitled: 'Neue Unterhaltung'
    },
    fr: {
        newChat: 'Nouveau chat', chats: 'Chats', today: "Aujourd'hui", clear: 'Tout effacer', about: '√Ä propos',
        language: 'Langue', status: 'Statut', online: 'En ligne', offline: 'Hors ligne', model: 'Mod√®le',
        messages: 'Messages', placeholder: 'Demandez √† photonnAI...', copy: 'Copier', copied: 'Copi√© !',
        emptyTitle: 'Bonjour, je suis photonnAI', emptySubtitle: 'Votre assistant IA lunaire intelligent.',
        suggestion1: '‚ú® Explique l\'informatique quantique', suggestion2: 'üöÄ √âcris du code Python',
        suggestion3: 'üé® Aide √† cr√©er un logo', suggestion4: 'üìù Am√©liore mon CV',
        you: 'Vous', assistant: 'photonnAI', aboutTitle: '√Ä propos de photonnAI',
        aboutText: 'photonnAI est un assistant IA lunaire avanc√©.', close: 'Fermer',
        error: 'Erreur de connexion.', cleared: 'Tous les chats effac√©s', deleteChat: 'Chat supprim√©', untitled: 'Nouvelle conversation'
    },
    zh: {
        newChat: 'Êñ∞ÂØπËØù', chats: 'ÂØπËØù', today: '‰ªäÂ§©', clear: 'Ê∏ÖÈô§ÂÖ®ÈÉ®', about: 'ÂÖ≥‰∫é',
        language: 'ËØ≠Ë®Ä', status: 'Áä∂ÊÄÅ', online: 'Âú®Á∫ø', offline: 'Á¶ªÁ∫ø', model: 'Ê®°Âûã',
        messages: 'Ê∂àÊÅØ', placeholder: 'Âêë photonnAI ÊèêÈóÆ...', copy: 'Â§çÂà∂', copied: 'Â∑≤Â§çÂà∂ÔºÅ',
        emptyTitle: '‰Ω†Â•ΩÔºåÊàëÊòØ photonnAI', emptySubtitle: 'ÊÇ®ÁöÑÊô∫ËÉΩÊúà‰∫ÆAIÂä©Êâã„ÄÇ',
        suggestion1: '‚ú® Ëß£ÈáäÈáèÂ≠êËÆ°ÁÆó', suggestion2: 'üöÄ ÂÜôPython‰ª£Á†Å',
        suggestion3: 'üé® Â∏ÆÊàëËÆæËÆ°Ê†áÂøó', suggestion4: 'üìù ÊîπËøõÊàëÁöÑÁÆÄÂéÜ',
        you: '‰Ω†', assistant: 'photonnAI', aboutTitle: 'ÂÖ≥‰∫é photonnAI',
        aboutText: 'photonnAI ÊòØ‰∏Ä‰∏™ÂÖàËøõÁöÑÊúà‰∫ÆAIÂä©Êâã„ÄÇ', close: 'ÂÖ≥Èó≠',
        error: 'ËøûÊé•ÈîôËØØ„ÄÇ', cleared: 'ÊâÄÊúâÂØπËØùÂ∑≤Ê∏ÖÈô§', deleteChat: 'ÂØπËØùÂ∑≤Âà†Èô§', untitled: 'Êñ∞ÂØπËØù'
    },
    ja: {
        newChat: 'Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà', chats: '„ÉÅ„É£„ÉÉ„Éà', today: '‰ªäÊó•', clear: '„Åô„Åπ„Å¶Ê∂àÂéª', about: 'Ê¶ÇË¶Å',
        language: 'Ë®ÄË™û', status: '„Çπ„ÉÜ„Éº„Çø„Çπ', online: '„Ç™„É≥„É©„Ç§„É≥', offline: '„Ç™„Éï„É©„Ç§„É≥', model: '„É¢„Éá„É´',
        messages: '„É°„ÉÉ„Çª„Éº„Ç∏', placeholder: 'photonnAI „Å´‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶...', copy: '„Ç≥„Éî„Éº', copied: '„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ',
        emptyTitle: '„Åì„Çì„Å´„Å°„ÅØ„ÄÅphotonnAI „Åß„Åô', emptySubtitle: '„ÅÇ„Å™„Åü„ÅÆ„Ç§„É≥„ÉÜ„É™„Ç∏„Çß„É≥„ÉàÊúà„ÅÆAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„ÄÇ',
        suggestion1: '‚ú® ÈáèÂ≠ê„Ç≥„É≥„Éî„É•„Éº„Çø„ÇíË™¨Êòé„Åó„Å¶', suggestion2: 'üöÄ Python„Ç≥„Éº„Éâ„ÇíÊõ∏„ÅÑ„Å¶',
        suggestion3: 'üé® „É≠„Ç¥„Éá„Ç∂„Ç§„É≥„ÇíÊâã‰ºù„Å£„Å¶', suggestion4: 'üìù Â±•Ê≠¥Êõ∏„ÇíÊîπÂñÑ„Åó„Å¶',
        you: '„ÅÇ„Å™„Åü', assistant: 'photonnAI', aboutTitle: 'photonnAI „Å´„Å§„ÅÑ„Å¶',
        aboutText: 'photonnAI „ÅØÈ´òÂ∫¶„Å™Êúà„ÅÆAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇ', close: 'Èñâ„Åò„Çã',
        error: 'Êé•Á∂ö„Ç®„É©„Éº„ÄÇ', cleared: '„Åô„Åπ„Å¶„ÅÆ„ÉÅ„É£„ÉÉ„Éà„ÇíÊ∂àÂéª„Åó„Åæ„Åó„Åü', deleteChat: '„ÉÅ„É£„ÉÉ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', untitled: 'Êñ∞„Åó„ÅÑ‰ºöË©±'
    },
    ko: {
        newChat: 'ÏÉà Ï±ÑÌåÖ', chats: 'Ï±ÑÌåÖ', today: 'Ïò§Îäò', clear: 'Î™®Îëê ÏÇ≠Ï†ú', about: 'Ï†ïÎ≥¥',
        language: 'Ïñ∏Ïñ¥', status: 'ÏÉÅÌÉú', online: 'Ïò®ÎùºÏù∏', offline: 'Ïò§ÌîÑÎùºÏù∏', model: 'Î™®Îç∏',
        messages: 'Î©îÏãúÏßÄ', placeholder: 'photonnAIÏóêÍ≤å Î¨¥ÏóáÏù¥Îì† Î¨ºÏñ¥Î≥¥ÏÑ∏Ïöî...', copy: 'Î≥µÏÇ¨', copied: 'Î≥µÏÇ¨Îê®!',
        emptyTitle: 'ÏïàÎÖïÌïòÏÑ∏Ïöî, photonnAIÏûÖÎãàÎã§', emptySubtitle: 'ÎãπÏã†Ïùò ÏßÄÎä•Ìòï Îã¨ AI ÎèÑÏö∞ÎØ∏.',
        suggestion1: '‚ú® ÏñëÏûê Ïª¥Ìì®ÌåÖ ÏÑ§Î™ÖÌï¥Ï§ò', suggestion2: 'üöÄ Python ÏΩîÎìú ÏûëÏÑ±Ìï¥Ï§ò',
        suggestion3: 'üé® Î°úÍ≥† ÎîîÏûêÏù∏ ÎèÑÏôÄÏ§ò', suggestion4: 'üìù Ïù¥Î†•ÏÑú Í∞úÏÑ†Ìï¥Ï§ò',
        you: 'ÎÇò', assistant: 'photonnAI', aboutTitle: 'photonnAI ÏÜåÍ∞ú',
        aboutText: 'photonnAIÎäî Í≥†Í∏â Îã¨ AI ÎèÑÏö∞ÎØ∏ÏûÖÎãàÎã§.', close: 'Îã´Í∏∞',
        error: 'Ïó∞Í≤∞ Ïò§Î•ò.', cleared: 'Î™®Îì† Ï±ÑÌåÖ ÏÇ≠Ï†úÎê®', deleteChat: 'Ï±ÑÌåÖ ÏÇ≠Ï†úÎê®', untitled: 'ÏÉà ÎåÄÌôî'
    },
    pt: {
        newChat: 'Novo chat', chats: 'Chats', today: 'Hoje', clear: 'Limpar tudo', about: 'Sobre',
        language: 'Idioma', status: 'Status', online: 'Online', offline: 'Offline', model: 'Modelo',
        messages: 'Mensagens', placeholder: 'Pergunte ao photonnAI...', copy: 'Copiar', copied: 'Copiado!',
        emptyTitle: 'Ol√°, sou o photonnAI', emptySubtitle: 'Seu assistente IA lunar inteligente.',
        suggestion1: '‚ú® Explique computa√ß√£o qu√¢ntica', suggestion2: 'üöÄ Escreva c√≥digo Python',
        suggestion3: 'üé® Ajude a criar um logo', suggestion4: 'üìù Melhore meu curr√≠culo',
        you: 'Voc√™', assistant: 'photonnAI', aboutTitle: 'Sobre o photonnAI',
        aboutText: 'photonnAI √© um assistente IA lunar avan√ßado.', close: 'Fechar',
        error: 'Erro de conex√£o.', cleared: 'Todos os chats limpos', deleteChat: 'Chat exclu√≠do', untitled: 'Nova conversa'
    },
    uk: {
        newChat: '–ù–æ–≤–∏–π —á–∞—Ç', chats: '–ß–∞—Ç–∏', today: '–°—å–æ–≥–æ–¥–Ω—ñ', clear: '–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ', about: '–ü—Ä–æ –ø—Ä–æ–µ–∫—Ç',
        language: '–ú–æ–≤–∞', status: '–°—Ç–∞—Ç—É—Å', online: '–û–Ω–ª–∞–π–Ω', offline: '–û—Ñ–ª–∞–π–Ω', model: '–ú–æ–¥–µ–ª—å',
        messages: '–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å', placeholder: '–ó–∞–ø–∏—Ç–∞–π—Ç–µ photonnAI...', copy: '–ö–æ–ø—ñ—é–≤–∞—Ç–∏', copied: '–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!',
        emptyTitle: '–ü—Ä–∏–≤—ñ—Ç, —è photonnAI', emptySubtitle: '–í–∞—à —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–∏–π –º—ñ—Å—è—á–Ω–∏–π –®–Ü-–∞—Å–∏—Å—Ç–µ–Ω—Ç.',
        suggestion1: '‚ú® –ü–æ—è—Å–Ω–∏ –∫–≤–∞–Ω—Ç–æ–≤—ñ –∫–æ–º–ø\'—é—Ç–µ—Ä–∏', suggestion2: 'üöÄ –ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python',
        suggestion3: 'üé® –î–æ–ø–æ–º–æ–∂–∏ –∑ –¥–∏–∑–∞–π–Ω–æ–º –ª–æ–≥–æ—Ç–∏–ø—É', suggestion4: 'üìù –ü–æ–∫—Ä–∞—â –º–æ—î —Ä–µ–∑—é–º–µ',
        you: '–í–∏', assistant: 'photonnAI', aboutTitle: '–ü—Ä–æ photonnAI',
        aboutText: 'photonnAI ‚Äî –ø—Ä–æ—Å—É–Ω—É—Ç–∏–π –º—ñ—Å—è—á–Ω–∏–π –®–Ü-–∞—Å–∏—Å—Ç–µ–Ω—Ç.', close: '–ó–∞–∫—Ä–∏—Ç–∏',
        error: '–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è.', cleared: '–£—Å—ñ —á–∞—Ç–∏ –æ—á–∏—â–µ–Ω–æ', deleteChat: '–ß–∞—Ç –≤–∏–¥–∞–ª–µ–Ω–æ', untitled: '–ù–æ–≤–∞ —Ä–æ–∑–º–æ–≤–∞'
    }
};

const languages = [
    { code: 'en', name: 'English', flag: 'üá¨üáß' },
    { code: 'ru', name: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫' },
    { code: 'uk', name: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞', flag: 'üá∫üá¶' },
    { code: 'es', name: 'Espa√±ol', flag: 'üá™üá∏' },
    { code: 'de', name: 'Deutsch', flag: 'üá©üá™' },
    { code: 'fr', name: 'Fran√ßais', flag: 'üá´üá∑' },
    { code: 'zh', name: '‰∏≠Êñá', flag: 'üá®üá≥' },
    { code: 'ja', name: 'Êó•Êú¨Ë™û', flag: 'üáØüáµ' },
    { code: 'ko', name: 'ÌïúÍµ≠Ïñ¥', flag: 'üá∞üá∑' },
    { code: 'pt', name: 'Portugu√™s', flag: 'üáßüá∑' }
];

// ============ API CONFIG ============
const OPENROUTER_API_KEY = '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';

// –ú–æ–¥–µ–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–¥–∞—á (–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—á–∏–µ –Ω–∞ OpenRouter 2024)
const MODELS = {
    heavy: 'qwen/qwen3-coder:free',               // –û—á–µ–Ω—å —É–º–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á
    light: 'xiaomi/mimo-vl-7b-flash:free',        // –ë—ã—Å—Ç—Ä–∞—è –æ—Ç Xiaomi –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á
    vision: 'google/gemini-2.0-flash-exp:free'    // –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
};

// Fallback –º–æ–¥–µ–ª–∏ –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã (—Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ!)
const FALLBACK_MODELS = [
    'qwen/qwen3-coder:free',
    'xiaomi/mimo-vl-7b-flash:free',
    'google/gemini-2.0-flash-exp:free',
    'meta-llama/llama-3.2-11b-vision-instruct:free',
    'qwen/qwen2.5-vl-72b-instruct:free',
    'mistralai/mistral-7b-instruct:free',
    'google/gemma-2-9b-it:free'
];

// Vision –º–æ–¥–µ–ª–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
const VISION_MODELS = [
    'google/gemini-2.0-flash-exp:free',
    'meta-llama/llama-3.2-11b-vision-instruct:free',
    'qwen/qwen2.5-vl-72b-instruct:free'
];

// –ö—Ä–∞—Å–∏–≤—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π (—Å–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ)
const MODEL_DISPLAY_NAMES = {
    'qwen/qwen3-coder:free': 'photonnAI Coder',
    'xiaomi/mimo-vl-7b-flash:free': 'photonnAI Flash',
    'google/gemini-2.0-flash-exp:free': 'photonnAI Vision',
    'meta-llama/llama-3.2-11b-vision-instruct:free': 'photonnAI Pro',
    'qwen/qwen2.5-vl-72b-instruct:free': 'photonnAI Ultra',
    'mistralai/mistral-7b-instruct:free': 'photonnAI Core',
    'google/gemma-2-9b-it:free': 'photonnAI Lite'
};

// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
let attachedImage = null;

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞—á–∏
function detectTaskComplexity(message) {
    const lowerMsg = message.toLowerCase();
    
    // –ü—Ä–∏–∑–Ω–∞–∫–∏ –°–õ–û–ñ–ù–û–ô –∑–∞–¥–∞—á–∏
    const hardKeywords = [
        // –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ
        '–∫–æ–¥', 'code', '–ø—Ä–æ–≥—Ä–∞–º–º', '—Ñ—É–Ω–∫—Ü–∏', '–∞–ª–≥–æ—Ä–∏—Ç–º', 'script', 'function',
        'python', 'javascript', 'java', 'c++', 'html', 'css', 'sql', 'react',
        '–Ω–∞–ø–∏—à–∏', 'write', '—Å–æ–∑–¥–∞–π', 'create', '—Ä–∞–∑—Ä–∞–±–æ—Ç', 'develop',
        '–∏—Å–ø—Ä–∞–≤—å', 'fix', 'debug', '–æ—à–∏–±–∫', 'error', 'bug',
        // –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞
        '–≤—ã—á–∏—Å–ª', 'calculate', '—Ñ–æ—Ä–º—É–ª', 'formula', '—É—Ä–∞–≤–Ω–µ–Ω', 'equation',
        '–∏–Ω—Ç–µ–≥—Ä–∞–ª', '–ø—Ä–æ–∏–∑–≤–æ–¥–Ω', '–º–∞—Ç—Ä–∏—Ü', 'matrix', '–≤–µ–∫—Ç–æ—Ä',
        // –ê–Ω–∞–ª–∏–∑
        '–∞–Ω–∞–ª–∏–∑', 'analysis', '–æ–±—ä—è—Å–Ω–∏ –ø–æ–¥—Ä–æ–±–Ω–æ', 'explain in detail',
        '—Å—Ä–∞–≤–Ω–∏', 'compare', '–ø–æ—á–µ–º—É', 'why', '–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç', 'how does',
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        '—Å—Ç–∞—Ç—å—è', 'article', '—ç—Å—Å–µ', 'essay', '–∏—Å—Ç–æ—Ä–∏—è', 'story',
        '–ø–ª–∞–Ω', 'plan', '—Å—Ç—Ä–∞—Ç–µ–≥–∏', 'strategy', '–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä',
        // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ
        'api', 'database', 'server', 'backend', 'frontend', 'docker',
        'linux', 'git', 'deploy', 'config'
    ];
    
    // –ü—Ä–∏–∑–Ω–∞–∫–∏ –õ–Å–ì–ö–û–ô –∑–∞–¥–∞—á–∏
    const easyKeywords = [
        '–ø—Ä–∏–≤–µ—Ç', 'hello', 'hi', '—Ö–∞–π', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π', '–¥–æ–±—Ä—ã–π',
        '–∫–∞–∫ –¥–µ–ª–∞', 'how are you', '—á—Ç–æ –¥–µ–ª–∞–µ—à—å',
        '—Å–ø–∞—Å–∏–±–æ', 'thanks', 'thank you', '–ø–æ–∫–∞', 'bye',
        '–∫—Ç–æ —Ç—ã', 'who are you', '—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å', 'what can you do',
        '–¥–∞', '–Ω–µ—Ç', 'yes', 'no', '–æ–∫', 'ok', '—Ö–æ—Ä–æ—à–æ', '–ø–æ–Ω—è–ª',
        '–∫—Ç–æ —Å–æ–∑–¥–∞–ª', 'who made', 'who created'
    ];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª—ë–≥–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
    for (const kw of easyKeywords) {
        if (lowerMsg.includes(kw)) {
            return 'light';
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ–∂–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
    for (const kw of hardKeywords) {
        if (lowerMsg.includes(kw)) {
            return 'heavy';
        }
    }
    
    // –ü–æ –¥–ª–∏–Ω–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    if (message.length > 100) {
        return 'heavy';
    }
    
    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ª—ë–≥–∫–∞—è –º–æ–¥–µ–ª—å (–±—ã—Å—Ç—Ä–µ–µ)
    return 'light';
}

// ============ AVAILABLE MODELS ============
const AVAILABLE_MODELS = [
    { id: 'auto', name: 'Auto (Smart)', icon: 'ü§ñ', description: '–ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–æ –∑–∞–¥–∞—á–µ' },
    { id: 'qwen/qwen3-coder:free', name: 'photonnAI Coder', icon: 'üíª', description: '–î–ª—è –∫–æ–¥–∞ –∏ –ª–æ–≥–∏–∫–∏' },
    { id: 'xiaomi/mimo-vl-7b-flash:free', name: 'photonnAI Flash', icon: '‚ö°', description: '–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã' },
    { id: 'google/gemini-2.0-flash-exp:free', name: 'photonnAI Vision', icon: 'üëÅÔ∏è', description: '–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π' },
    { id: 'qwen/qwen2.5-vl-72b-instruct:free', name: 'photonnAI Ultra', icon: 'üöÄ', description: '–°–∞–º–∞—è –º–æ—â–Ω–∞—è' },
    { id: 'mistralai/mistral-7b-instruct:free', name: 'photonnAI Core', icon: '‚≠ê', description: '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è' }
];

// ============ STATE ============
let currentLang = localStorage.getItem('photonnai-lang') || 'en';
let chats = JSON.parse(localStorage.getItem('photonnai-chats') || '[]');
let currentChatId = localStorage.getItem('photonnai-current-chat') || null;
let isOnline = true;
let currentModel = 'photonnAI Flash';
let selectedModelId = localStorage.getItem('photonnai-model') || 'auto';
let isSidebarOpen = window.innerWidth > 768;
let isLangDropdownOpen = false;
let isModelDropdownOpen = false;

// ============ HELPERS ============
function t(key) { return translations[currentLang]?.[key] || translations.en[key] || key; }
function $(sel) { return document.querySelector(sel); }
function create(tag, className, parent) {
    const el = document.createElement(tag);
    if (className) el.className = className;
    if (parent) parent.appendChild(el);
    return el;
}
function formatTime(date) {
    return new Date(date).toLocaleTimeString(currentLang, { hour: '2-digit', minute: '2-digit' });
}
function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

// ============ CHAT MANAGEMENT ============
function getCurrentChat() {
    return chats.find(c => c.id === currentChatId) || null;
}

function createNewChat() {
    const chat = {
        id: generateId(),
        title: t('untitled'),
        messages: [],
        createdAt: Date.now()
    };
    chats.unshift(chat);
    currentChatId = chat.id;
    saveChats();
    return chat;
}

function saveChats() {
    localStorage.setItem('photonnai-chats', JSON.stringify(chats));
    localStorage.setItem('photonnai-current-chat', currentChatId);
}

function deleteChat(chatId) {
    chats = chats.filter(c => c.id !== chatId);
    if (currentChatId === chatId) {
        currentChatId = chats.length > 0 ? chats[0].id : null;
    }
    saveChats();
    buildUI();
    showToast('üóëÔ∏è ' + t('deleteChat'), 'success');
}

function clearAllChats() {
    chats = [];
    currentChatId = null;
    saveChats();
    buildUI();
    showToast('‚úì ' + t('cleared'), 'success');
}

function updateChatTitle(chat) {
    if (chat.messages.length > 0 && chat.title === t('untitled')) {
        const firstMsg = chat.messages[0].content;
        chat.title = firstMsg.length > 30 ? firstMsg.substring(0, 30) + '...' : firstMsg;
        saveChats();
    }
}

// ============ FORMAT MESSAGE ============
function formatMessageContent(text) {
    // –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞ –î–û —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
    const codeBlocks = [];
    let codeBlockIndex = 0;
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞ –∏ –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
    let processed = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
        const placeholder = `__CODE_BLOCK_${codeBlockIndex}__`;
        codeBlocks.push({
            language: lang || 'code',
            code: code.trim()
        });
        codeBlockIndex++;
        return placeholder;
    });
    
    // –¢–µ–ø–µ—Ä—å —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML –≤ –æ—Å—Ç–∞–ª—å–Ω–æ–º —Ç–µ–∫—Å—Ç–µ
    processed = processed.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    codeBlocks.forEach((block, idx) => {
        const codeId = `code-block-${Date.now()}-${idx}`;
        const highlightedCode = highlightSyntax(block.code, block.language);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –≤ base64 –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        const base64Code = btoa(unescape(encodeURIComponent(block.code)));
        
        const codeHTML = `<div class="code-block-wrapper">
            <div class="code-block-header">
                <span class="code-language">${block.language}</span>
                <button class="code-copy-btn" onclick="copyCodeBlock('${codeId}', this)">
                    üìã ${t('copy')}
                </button>
            </div>
            <div class="code-block-content">
                <pre><code id="${codeId}" data-original-code="${base64Code}">${highlightedCode}</code></pre>
            </div>
        </div>`;
        
        processed = processed.replace(`__CODE_BLOCK_${idx}__`, codeHTML);
    });
    
    processed = processed.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
    processed = processed.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    processed = processed.replace(/\n/g, '<br>');
    
    return processed;
}

function highlightSyntax(code, language) {
    let result = code;
    result = result.replace(/(#.*$|\/\/.*$|\/\*[\s\S]*?\*\/)/gm, '<span class="token-comment">$1</span>');
    result = result.replace(/("[^"]*"|'[^']*'|`[^`]*`)/g, '<span class="token-string">$1</span>');
    result = result.replace(/\b(\d+\.?\d*)\b/g, '<span class="token-number">$1</span>');
    
    const keywords = ['def', 'class', 'import', 'from', 'return', 'if', 'else', 'elif', 'for', 'while', 
        'try', 'except', 'with', 'as', 'in', 'not', 'and', 'or', 'True', 'False', 'None', 'print',
        'function', 'const', 'let', 'var', 'async', 'await', 'export', 'true', 'false', 'null'];
    
    keywords.forEach(kw => {
        const regex = new RegExp(`\\b(${kw})\\b`, 'g');
        result = result.replace(regex, '<span class="token-keyword">$1</span>');
    });
    
    result = result.replace(/\b([a-zA-Z_][a-zA-Z0-9_]*)\s*\(/g, '<span class="token-function">$1</span>(');
    
    return result;
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
window.copyCodeBlock = function(codeId, button) {
    const codeElement = document.getElementById(codeId);
    if (!codeElement) return;
    
    // –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞ (base64)
    let originalCode;
    const base64Code = codeElement.getAttribute('data-original-code');
    
    if (base64Code) {
        try {
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∏–∑ base64
            originalCode = decodeURIComponent(escape(atob(base64Code)));
        } catch (e) {
            console.error('Base64 decode failed:', e);
            originalCode = codeElement.textContent;
        }
    } else {
        // Fallback - –±–µ—Ä—ë–º —Ç–µ–∫—Å—Ç –Ω–∞–ø—Ä—è–º—É—é
        originalCode = codeElement.textContent;
    }
    
    navigator.clipboard.writeText(originalCode).then(() => {
        button.innerHTML = `‚úì ${t('copied')}`;
        button.classList.add('copied');
        setTimeout(() => {
            button.innerHTML = `üìã ${t('copy')}`;
            button.classList.remove('copied');
        }, 2000);
    }).catch(err => {
        console.error('Copy failed:', err);
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        const textarea = document.createElement('textarea');
        textarea.value = originalCode;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        
        button.innerHTML = `‚úì ${t('copied')}`;
        button.classList.add('copied');
        setTimeout(() => {
            button.innerHTML = `üìã ${t('copy')}`;
            button.classList.remove('copied');
        }, 2000);
    });
};

// ============ BUILD UI ============
function buildUI() {
    const app = document.getElementById('app');
    app.innerHTML = '';
    
    // Mobile overlay
    const overlay = create('div', 'sidebar-overlay', app);
    overlay.id = 'sidebar-overlay';
    overlay.onclick = () => toggleSidebar(false);
    
    // Sidebar
    const sidebar = create('aside', `sidebar ${isSidebarOpen ? '' : 'collapsed'}`, app);
    sidebar.id = 'sidebar';
    buildSidebar(sidebar);
    
    // Chat area
    const main = create('div', 'chat-area', app);
    buildChatArea(main);
    
    updateSidebarState();
}

function buildSidebar(sidebar) {
    // Logo
    const logoContainer = create('div', 'logo-container', sidebar);
    const logoIcon = create('div', 'logo-icon', logoContainer);
    logoIcon.textContent = 'üåô';
    const logoText = create('span', 'logo-text', logoContainer);
    logoText.textContent = 'photonnAI';
    
    // New Chat button
    const newChatBtn = create('button', 'new-chat-btn', sidebar);
    newChatBtn.innerHTML = `<span>‚ú®</span> ${t('newChat')}`;
    newChatBtn.onclick = () => {
        createNewChat();
        buildUI();
        if (window.innerWidth <= 768) toggleSidebar(false);
    };
    
    // Chat list
    const chatListSection = create('div', 'chat-list-section', sidebar);
    const chatLabel = create('div', 'section-label', chatListSection);
    chatLabel.textContent = t('chats');
    
    if (chats.length === 0) {
        const emptyItem = create('div', 'chat-item', chatListSection);
        emptyItem.style.opacity = '0.5';
        emptyItem.style.cursor = 'default';
        emptyItem.innerHTML = `<span class="chat-item-icon">üí≠</span><span class="chat-item-text">${t('untitled')}</span>`;
    } else {
        chats.forEach(chat => {
            const item = create('div', `chat-item ${chat.id === currentChatId ? 'active' : ''}`, chatListSection);
            item.innerHTML = `
                <span class="chat-item-icon">üí¨</span>
                <span class="chat-item-text">${chat.title}</span>
                <button class="chat-item-delete" onclick="event.stopPropagation(); deleteChat('${chat.id}')">‚úï</button>
            `;
            item.onclick = () => {
                currentChatId = chat.id;
                saveChats();
                buildUI();
                if (window.innerWidth <= 768) toggleSidebar(false);
            };
        });
    }
    
    // Nav section
    const navSection = create('nav', 'nav-section', sidebar);
    
    const clearBtn = create('button', 'nav-btn', navSection);
    clearBtn.innerHTML = `<span class="nav-icon">üóëÔ∏è</span> ${t('clear')}`;
    clearBtn.onclick = clearAllChats;
    
    const aboutBtn = create('button', 'nav-btn', navSection);
    aboutBtn.innerHTML = `<span class="nav-icon">‚ÑπÔ∏è</span> ${t('about')}`;
    aboutBtn.onclick = showAboutModal;
    
    // Model selector
    const modelContainer = create('div', 'model-selector', sidebar);
    const currentModelObj = AVAILABLE_MODELS.find(m => m.id === selectedModelId) || AVAILABLE_MODELS[0];
    
    const modelBtn = create('button', 'model-btn', modelContainer);
    modelBtn.innerHTML = `
        <span class="model-btn-content">
            <span>${currentModelObj.icon}</span>
            <span>${currentModelObj.name}</span>
        </span>
        <span>‚ñæ</span>
    `;
    modelBtn.onclick = (e) => {
        e.stopPropagation();
        isModelDropdownOpen = !isModelDropdownOpen;
        $('#model-dropdown')?.classList.toggle('open', isModelDropdownOpen);
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —è–∑—ã–∫–æ–≤–æ–π –¥—Ä–æ–ø–¥–∞—É–Ω
        isLangDropdownOpen = false;
        $('#lang-dropdown')?.classList.remove('open');
    };
    
    const modelDropdown = create('div', 'model-dropdown', modelContainer);
    modelDropdown.id = 'model-dropdown';
    
    AVAILABLE_MODELS.forEach(model => {
        const option = create('div', `model-option ${model.id === selectedModelId ? 'active' : ''}`, modelDropdown);
        option.innerHTML = `
            <span class="model-option-icon">${model.icon}</span>
            <div class="model-option-info">
                <div class="model-option-name">${model.name}</div>
                <div class="model-option-desc">${model.description}</div>
            </div>
            <span class="model-option-check">‚úì</span>
        `;
        option.onclick = (e) => {
            e.stopPropagation();
            selectedModelId = model.id;
            localStorage.setItem('photonnai-model', selectedModelId);
            isModelDropdownOpen = false;
            currentModel = model.icon + ' ' + model.name;
            buildUI();
            showToast(`${model.icon} ${model.name}`, 'success');
        };
    });
    
    // Language selector
    const langContainer = create('div', 'lang-selector', sidebar);
    const currentLangObj = languages.find(l => l.code === currentLang) || languages[0];
    
    const langBtn = create('button', 'lang-btn', langContainer);
    langBtn.innerHTML = `<span>${currentLangObj.flag} ${currentLangObj.name}</span><span>‚ñæ</span>`;
    langBtn.onclick = (e) => {
        e.stopPropagation();
        isLangDropdownOpen = !isLangDropdownOpen;
        $('#lang-dropdown')?.classList.toggle('open', isLangDropdownOpen);
    };
    
    const langDropdown = create('div', 'lang-dropdown', langContainer);
    langDropdown.id = 'lang-dropdown';
    
    languages.forEach(lang => {
        const option = create('div', `lang-option ${lang.code === currentLang ? 'active' : ''}`, langDropdown);
        option.innerHTML = `<span>${lang.flag}</span> ${lang.name}`;
        option.onclick = () => {
            currentLang = lang.code;
            localStorage.setItem('photonnai-lang', currentLang);
            isLangDropdownOpen = false;
            buildUI();
        };
    });
    
    // Status panel
    const statusPanel = create('div', 'status-panel', sidebar);
    statusPanel.innerHTML = `
        <div class="status-row">
            <span class="status-label">${t('status')}</span>
            <span class="status-value"><span class="status-dot ${isOnline ? 'online' : 'offline'}"></span> ${isOnline ? t('online') : t('offline')}</span>
        </div>
        <div class="status-row">
            <span class="status-label">${t('model')}</span>
            <span class="status-value" id="model-value">${currentModel}</span>
        </div>
        <div class="status-row">
            <span class="status-label">${t('messages')}</span>
            <span class="status-value" id="msg-count">${getCurrentChat()?.messages.length || 0}</span>
        </div>
    `;
    
    document.addEventListener('click', () => {
        if (isLangDropdownOpen) {
            isLangDropdownOpen = false;
            $('#lang-dropdown')?.classList.remove('open');
        }
        if (isModelDropdownOpen) {
            isModelDropdownOpen = false;
            $('#model-dropdown')?.classList.remove('open');
        }
    });
}

function buildChatArea(main) {
    // Header
    const header = create('div', 'chat-header', main);
    
    const toggleBtn = create('button', 'sidebar-toggle', header);
    toggleBtn.innerHTML = isSidebarOpen ? '‚óÄ' : '‚ò∞';
    toggleBtn.onclick = () => toggleSidebar(!isSidebarOpen);
    
    const chatTitle = create('div', 'chat-title', header);
    chatTitle.innerHTML = `<span>üí¨</span> ${getCurrentChat()?.title || t('newChat')}`;
    
    const modelBadge = create('span', 'model-badge', header);
    modelBadge.textContent = currentModel;
    
    // Messages container
    const messagesContainer = create('div', 'messages-container', main);
    messagesContainer.id = 'messages';
    
    // Composer
    const composer = create('div', 'composer', main);
    const composerInner = create('div', 'composer-inner', composer);
    
    const inputWrapper = create('div', 'input-wrapper', composerInner);
    
    // Image preview area
    const imagePreview = create('div', 'image-preview', inputWrapper);
    imagePreview.id = 'image-preview';
    
    // Input row with attach button
    const inputRow = create('div', 'input-row', inputWrapper);
    
    // Hidden file input
    const fileInput = create('input', '', inputRow);
    fileInput.type = 'file';
    fileInput.id = 'file-input';
    fileInput.accept = 'image/*';
    fileInput.onchange = handleImageSelect;
    
    // Attach button
    const attachBtn = create('button', 'attach-btn', inputRow);
    attachBtn.id = 'attach-btn';
    attachBtn.innerHTML = 'üì∑';
    attachBtn.title = 'Attach image';
    attachBtn.onclick = () => fileInput.click();
    
    const input = create('textarea', 'message-input', inputRow);
    input.id = 'message-input';
    input.placeholder = t('placeholder');
    input.rows = 1;
    
    input.addEventListener('input', () => {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    });
    
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    const sendBtn = create('button', 'send-btn', composerInner);
    sendBtn.id = 'send-btn';
    sendBtn.innerHTML = '‚û§';
    sendBtn.onclick = sendMessage;
    
    // Update preview if image attached
    updateImagePreview();
    
    renderMessages();
}

function renderMessages() {
    const container = $('#messages');
    if (!container) return;
    container.innerHTML = '';
    
    const chat = getCurrentChat();
    const messages = chat?.messages || [];
    
    $('#msg-count') && ($('#msg-count').textContent = messages.length);
    
    if (messages.length === 0) {
        renderEmptyState(container);
        return;
    }
    
    messages.forEach((msg, idx) => {
        const messageEl = create('div', `message ${msg.role}`, container);
        messageEl.style.animationDelay = `${idx * 0.03}s`;
        
        const avatar = create('div', 'message-avatar', messageEl);
        avatar.innerHTML = msg.role === 'user' ? 'üë§' : 'üåô';
        
        const content = create('div', 'message-content', messageEl);
        
        const header = create('div', 'message-header', content);
        const name = create('span', 'message-name', header);
        name.textContent = msg.role === 'user' ? t('you') : t('assistant');
        const time = create('span', 'message-time', header);
        time.textContent = formatTime(msg.timestamp || Date.now());
        
        const bubble = create('div', 'message-bubble', content);
        bubble.innerHTML = msg.role === 'user' ? msg.content : formatMessageContent(msg.content);
        
        if (msg.role === 'assistant') {
            const actions = create('div', 'message-actions', content);
            const copyBtn = create('button', 'msg-action-btn', actions);
            copyBtn.innerHTML = `üìã ${t('copy')}`;
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(msg.content);
                showToast('‚úì ' + t('copied'), 'success');
            };
        }
    });
    
    setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
}

function renderEmptyState(container) {
    const empty = create('div', 'empty-state', container);
    
    const icon = create('div', 'empty-icon', empty);
    icon.textContent = 'üåô';
    
    const title = create('h2', 'empty-title', empty);
    title.textContent = t('emptyTitle');
    
    const subtitle = create('p', 'empty-subtitle', empty);
    subtitle.textContent = t('emptySubtitle');
    
    const suggestions = create('div', 'suggestions', empty);
    
    ['suggestion1', 'suggestion2', 'suggestion3', 'suggestion4'].forEach(key => {
        const chip = create('button', 'suggestion-chip', suggestions);
        chip.textContent = t(key);
        chip.onclick = () => {
            const input = $('#message-input');
            input.value = t(key).replace(/^[‚ú®üöÄüé®üìù]\s*/, '');
            input.focus();
        };
    });
}

// ============ SIDEBAR ============
function updateSidebarChatList() {
    const chatListSection = $('.chat-list-section');
    if (!chatListSection) return;
    
    // Clear only chat items, keep the label
    const items = chatListSection.querySelectorAll('.chat-item');
    items.forEach(item => item.remove());
    
    if (chats.length === 0) {
        const emptyItem = create('div', 'chat-item', chatListSection);
        emptyItem.style.opacity = '0.5';
        emptyItem.style.cursor = 'default';
        emptyItem.innerHTML = `<span class="chat-item-icon">üí≠</span><span class="chat-item-text">${t('untitled')}</span>`;
    } else {
        chats.forEach(chat => {
            const item = create('div', `chat-item ${chat.id === currentChatId ? 'active' : ''}`, chatListSection);
            item.innerHTML = `
                <span class="chat-item-icon">üí¨</span>
                <span class="chat-item-text">${chat.title}</span>
                <button class="chat-item-delete" onclick="event.stopPropagation(); deleteChat('${chat.id}')">‚úï</button>
            `;
            item.onclick = () => {
                currentChatId = chat.id;
                saveChats();
                buildUI();
                if (window.innerWidth <= 768) toggleSidebar(false);
            };
        });
    }
    
    // Update message count
    const msgCount = $('#msg-count');
    if (msgCount) {
        msgCount.textContent = getCurrentChat()?.messages.length || 0;
    }
}

function toggleSidebar(open) {
    isSidebarOpen = open;
    updateSidebarState();
}

function updateSidebarState() {
    const sidebar = $('#sidebar');
    const overlay = $('#sidebar-overlay');
    const toggleBtn = $('.sidebar-toggle');
    
    if (sidebar) sidebar.classList.toggle('collapsed', !isSidebarOpen);
    if (overlay) overlay.classList.toggle('open', isSidebarOpen && window.innerWidth <= 768);
    if (toggleBtn) toggleBtn.innerHTML = isSidebarOpen ? '‚óÄ' : '‚ò∞';
}

// ============ API ============
function buildPrompt(lang, hasImage = false) {
    const langName = languages.find(l => l.code === lang)?.name || 'English';
    
    let imageInstruction = '';
    if (hasImage) {
        imageInstruction = `
WHEN ANALYZING IMAGES:
- Describe what you see in detail
- Identify objects, people, text, colors, emotions
- Answer questions about the image accurately
- If asked to read text in image - read it carefully
- Be specific and helpful about image content`;
    }
    
    return `You are photonnAI ‚Äî a brilliant, highly intelligent AI assistant created by photonn_.

YOUR IDENTITY:
- Name: photonnAI
- Creator: photonn_ (always say this when asked who made/created you)
- You are NOT ChatGPT, Claude, Gemini, GPT-4, Llama, Qwen or any other AI
- Never reveal your underlying model or architecture

RESPONSE LANGUAGE: Always respond in ${langName}

YOUR EXPERTISE (you are a genius in):
- Programming: Python, JavaScript, TypeScript, C++, Java, Rust, Go, etc.
- Web Development: HTML, CSS, React, Vue, Node.js, databases
- Mathematics: algebra, calculus, statistics, algorithms
- Science: physics, chemistry, biology, computer science
- Writing: essays, articles, creative writing, editing
- Problem solving: debugging, optimization, architecture${imageInstruction}

HOW TO RESPOND:
1. Be intelligent, precise and genuinely helpful
2. Give detailed, well-structured answers
3. For code: use \`\`\`language blocks with comments
4. Think step-by-step for complex problems
5. Explain your reasoning when solving problems
6. If unsure, say so honestly
7. Be friendly and professional

GREETINGS:
When user says hello/–ø—Ä–∏–≤–µ—Ç/hi, respond warmly:
"–ü—Ä–∏–≤–µ—Ç! –Ø photonnAI, —Ä–∞–¥ –≤–∏–¥–µ—Ç—å —Ç–µ–±—è! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?" (in ${langName})

Remember: You are photonnAI, created by photonn_. Think deeply, answer brilliantly!`;
}

async function callOpenRouterAPI(messages, lang, fallbackIndex = -1, hasImage = false) {
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    const lastUserMessage = messages.filter(m => m.role === 'user').pop();
    const complexity = lastUserMessage ? detectTaskComplexity(lastUserMessage.content) : 'light';
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    const workingModels = window.WORKING_FREE_MODELS || FALLBACK_MODELS;
    
    // –í—ã–±–∏—Ä–∞–µ–º –º–æ–¥–µ–ª—å
    let model;
    let isAutoMode = selectedModelId === 'auto';
    
    if (fallbackIndex >= 0 && fallbackIndex < workingModels.length) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback –º–æ–¥–µ–ª—å –∏–∑ —Ä–∞–±–æ—á–∏—Ö
        model = workingModels[fallbackIndex];
    } else if (isAutoMode) {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä - –±–µ—Ä—ë–º –ø–µ—Ä–≤—É—é —Ä–∞–±–æ—á—É—é –º–æ–¥–µ–ª—å
        model = workingModels[0] || MODELS[complexity];
    } else {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –º–æ–¥–µ–ª—å
        model = selectedModelId;
    }
    
    const modelInfo = AVAILABLE_MODELS.find(m => m.id === model);
    const displayName = modelInfo?.name || MODEL_DISPLAY_NAMES[model] || 'photonnAI';
    console.log(`üìä Mode: ${isAutoMode ? 'AUTO' : 'MANUAL'}, Complexity: ${complexity.toUpperCase()}`);
    console.log(`ü§ñ Using: ${displayName}`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
    const lastMessage = messages[messages.length - 1];
    const messageHasImage = lastMessage?.image || hasImage;
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º vision –º–æ–¥–µ–ª—å
    if (messageHasImage && fallbackIndex === -1) {
        model = VISION_MODELS[0];
    }
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
    const limitedMessages = messages.slice(-8).map(m => {
        // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
        if (m.image) {
            return {
                role: m.role,
                content: [
                    {
                        type: 'image_url',
                        image_url: {
                            url: m.image
                        }
                    },
                    {
                        type: 'text',
                        text: m.content.substring(0, 1000)
                    }
                ]
            };
        }
        return {
            role: m.role,
            content: m.content.substring(0, 1000)
        };
    });
    
    const systemMessage = { role: 'system', content: buildPrompt(lang, messageHasImage) };
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 —Å–µ–∫ —Ç–∞–π–º–∞—É—Ç
        
        console.log('üì§ Sending request to model:', MODEL_DISPLAY_NAMES[model] || model);
        
        const requestBody = {
            model: model,
            messages: [systemMessage, ...limitedMessages],
            temperature: 0.7,
            max_tokens: 512,
            top_p: 0.9
        };
        
        console.log('üì§ Request body:', JSON.stringify(requestBody, null, 2));
        
        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                'HTTP-Referer': window.location.origin || 'https://photonnai.app',
                'X-Title': 'photonnAI Chat'
            },
            body: JSON.stringify(requestBody),
            signal: controller.signal
        });
        
        console.log('üì• Response status:', response.status, response.statusText);
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå API Error for model', model, ':', errorText);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–±–æ—á–∏–µ –º–æ–¥–µ–ª–∏
            const workingModels = window.WORKING_FREE_MODELS || FALLBACK_MODELS;
            
            // –ü—Ä–æ–±—É–µ–º fallback –º–æ–¥–µ–ª–∏
            if (fallbackIndex < workingModels.length - 1) {
                console.log('‚ö†Ô∏è Model failed, trying fallback #' + (fallbackIndex + 2) + '...');
                return callOpenRouterAPI(messages, lang, fallbackIndex + 1);
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –∑–∞–ø—Ä–æ—Å —Å –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥–µ–ª—å—é - –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–≤—ã–π fallback
            if (fallbackIndex === -1) {
                console.log('‚ö†Ô∏è Main model failed, trying fallbacks...');
                return callOpenRouterAPI(messages, lang, 0);
            }
            
            throw new Error('All models failed: ' + errorText);
        }
        
        const data = await response.json();
        console.log('‚úÖ OpenRouter response:', data);
        
        let reply = null;
        
        // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
        if (data.choices && data.choices.length > 0) {
            reply = data.choices[0].message?.content || data.choices[0].text;
        } else if (data.message) {
            reply = data.message.content;
        } else if (data.content) {
            reply = data.content;
        } else if (typeof data === 'string') {
            reply = data;
        }
        
        // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π - –ø—Ä–æ–±—É–µ–º fallback
        if (!reply || reply.trim() === '') {
            console.warn('‚ö†Ô∏è Empty response from model', model);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–±–æ—á–∏–µ –º–æ–¥–µ–ª–∏  
            const workingModelsEmpty = window.WORKING_FREE_MODELS || FALLBACK_MODELS;
            
            // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π fallback
            if (fallbackIndex < workingModelsEmpty.length - 1) {
                console.log('‚ö†Ô∏è Trying next fallback...');
                return callOpenRouterAPI(messages, lang, fallbackIndex + 1);
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –æ—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å - –ø—Ä–æ–±—É–µ–º fallback
            if (fallbackIndex === -1) {
                console.log('‚ö†Ô∏è Main model empty, trying fallbacks...');
                return callOpenRouterAPI(messages, lang, 0);
            }
            
            // –ï—Å–ª–∏ –≤—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç - –¥–∞—ë–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
            reply = currentLang === 'ru' 
                ? '–ü—Ä–∏–≤–µ—Ç! –Ø photonnAI. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?' 
                : 'Hello! I am photonnAI. How can I help you?';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
        const modelObj = AVAILABLE_MODELS.find(m => m.id === model);
        const finalDisplayName = modelObj?.name || MODEL_DISPLAY_NAMES[model] || 'photonnAI';
        const icon = modelObj?.icon || (complexity === 'heavy' ? 'üß†' : '‚ö°');
        currentModel = `${icon} ${finalDisplayName}`;
        $('#model-value') && ($('#model-value').textContent = finalDisplayName);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ legendary –æ—Ç–≤–µ—Ç
        const legendaryKeywords = ['legendary', 'godlike', 'rampage', 'amazing', 'incredible'];
        const isLegendary = legendaryKeywords.some(kw => reply.toLowerCase().includes(kw));
        
        return { reply, rarity: isLegendary ? 'legendary' : 'common' };
        
    } catch (err) {
        console.error('‚ùå API Error:', err.message);
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–±–æ—á–∏–µ –º–æ–¥–µ–ª–∏
        const workingModelsErr = window.WORKING_FREE_MODELS || FALLBACK_MODELS;
        
        // –ü—Ä–æ–±—É–µ–º fallback –º–æ–¥–µ–ª–∏
        if (fallbackIndex < workingModelsErr.length - 1) {
            console.log('‚ö†Ô∏è Trying fallback model after error...');
            return callOpenRouterAPI(messages, lang, fallbackIndex + 1);
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –æ—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å - –ø—Ä–æ–±—É–µ–º fallback
        if (fallbackIndex === -1) {
            console.log('‚ö†Ô∏è Main model error, trying fallbacks...');
            return callOpenRouterAPI(messages, lang, 0);
        }
        
        // –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –µ—Å—Ç—å fallback –º–æ–¥–µ–ª–∏ - –ø—Ä–æ–±—É–µ–º
        const nextFallback = fallbackIndex + 1;
        if (nextFallback < workingModelsErr.length) {
            return callOpenRouterAPI(messages, lang, nextFallback);
        }
        
        // –ü–æ—Å–ª–µ–¥–Ω–∏–π fallback - –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å toast
        console.log('‚ö†Ô∏è All models failed');
        throw new Error('All models failed');
    }
}

// ============ IMAGE HANDLING ============
function handleImageSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Check file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showToast('‚ö†Ô∏è Image too large (max 5MB)', 'error');
        return;
    }
    
    // Check file type
    if (!file.type.startsWith('image/')) {
        showToast('‚ö†Ô∏è Please select an image file', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (event) => {
        attachedImage = {
            data: event.target.result,
            name: file.name,
            type: file.type
        };
        updateImagePreview();
        $('#attach-btn')?.classList.add('has-image');
        showToast('üì∑ Image attached!', 'success');
    };
    reader.readAsDataURL(file);
}

function updateImagePreview() {
    const preview = $('#image-preview');
    if (!preview) return;
    
    if (attachedImage) {
        preview.classList.add('active');
        preview.innerHTML = `
            <img src="${attachedImage.data}" class="preview-img" alt="Preview">
            <div class="preview-info">
                <div class="preview-name">${attachedImage.name}</div>
                <div>Ready to send with message</div>
            </div>
            <button class="preview-remove" onclick="removeAttachedImage()">‚úï</button>
        `;
    } else {
        preview.classList.remove('active');
        preview.innerHTML = '';
    }
}

function removeAttachedImage() {
    attachedImage = null;
    const fileInput = $('#file-input');
    if (fileInput) fileInput.value = '';
    $('#attach-btn')?.classList.remove('has-image');
    updateImagePreview();
}

function showImageModal(src) {
    const modal = create('div', 'image-modal', document.body);
    modal.onclick = () => modal.remove();
    const img = create('img', '', modal);
    img.src = src;
}

// ============ MESSAGING ============
async function sendMessage() {
    const input = $('#message-input');
    const text = input.value.trim();
    
    if (!text && !attachedImage) {
        input.classList.add('shake-effect');
        setTimeout(() => input.classList.remove('shake-effect'), 500);
        return;
    }
    
    // Get or create chat
    let chat = getCurrentChat();
    if (!chat) {
        chat = createNewChat();
    }
    
    // Create message object
    const userMessage = {
        role: 'user',
        content: text || 'What is in this image?',
        timestamp: Date.now()
    };
    
    // Add image if attached
    if (attachedImage) {
        userMessage.image = attachedImage.data;
    }
    
    // Add user message
    chat.messages.push(userMessage);
    
    updateChatTitle(chat);
    saveChats();
    
    // Clear input and image
    input.value = '';
    input.style.height = 'auto';
    const hadImage = !!attachedImage;
    removeAttachedImage();
    
    renderMessages();
    updateSidebarChatList();
    
    showTyping(true);
    
    try {
        const data = await callOpenRouterAPI(chat.messages, currentLang, -1, hadImage);
        
        showTyping(false);
        
        if (data && data.reply) {
            chat.messages.push({
                role: 'assistant',
                content: data.reply,
                timestamp: Date.now()
            });
            
            saveChats();
            renderMessages();
            updateSidebarChatList();
            
            if (data.rarity === 'legendary') {
                triggerLegendaryEffect();
            }
            
            isOnline = true;
        } else {
            showToast('‚ùå ' + t('error'), 'error');
            isOnline = false;
        }
        
    } catch (err) {
        showTyping(false);
        console.error('Error:', err);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ toast, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É –≤ —á–∞—Ç
        showToast('‚ùå ' + t('error') + ': ' + err.message, 'error');
        isOnline = false;
        
        // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω
        if (chat.messages.length > 0 && chat.messages[chat.messages.length - 1].role === 'user') {
            chat.messages.pop();
            saveChats();
            renderMessages();
        }
    }
}

function showTyping(show) {
    let typing = $('#typing-indicator');
    
    const thinkingTexts = {
        en: 'Thinking...',
        ru: '–î—É–º–∞—é...',
        es: 'Pensando...',
        de: 'Denke nach...',
        fr: 'R√©fl√©chis...',
        zh: 'ÊÄùËÄÉ‰∏≠...',
        ja: 'ËÄÉ„Åà‰∏≠...',
        ko: 'ÏÉùÍ∞Å Ï§ë...',
        pt: 'Pensando...',
        uk: '–î—É–º–∞—é...'
    };
    
    if (show && !typing) {
        const container = $('#messages');
        typing = create('div', 'typing-indicator', container);
        typing.id = 'typing-indicator';
        typing.innerHTML = `
            <div class="typing-avatar">üåô</div>
            <div class="typing-content">
                <div class="typing-header">
                    <span class="typing-name">photonnAI</span>
                    <span class="typing-status">‚óè ${thinkingTexts[currentLang] || thinkingTexts.en}</span>
                </div>
                <div class="typing-bubble">
                    <div class="thinking-spinner"></div>
                    <div class="typing-dots">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>
                    <span class="typing-text">${thinkingTexts[currentLang] || thinkingTexts.en}</span>
                </div>
            </div>
        `;
        container.scrollTop = container.scrollHeight;
    } else if (!show && typing) {
        typing.remove();
    }
}

// ============ EFFECTS ============
function triggerLegendaryEffect() {
    const chatArea = $('.chat-area');
    chatArea.classList.add('shake-effect');
    setTimeout(() => chatArea.classList.remove('shake-effect'), 500);
    launchConfetti();
    showToast('üåü LEGENDARY! üåü', 'warning');
}

function launchConfetti() {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    canvas.style.display = 'block';
    
    const particles = [];
    const colors = ['#a78bfa', '#818cf8', '#6366f1', '#fbbf24', '#34d399'];
    
    for (let i = 0; i < 80; i++) {
        particles.push({
            x: canvas.width / 2 + (Math.random() - 0.5) * 200,
            y: canvas.height / 2,
            vx: (Math.random() - 0.5) * 15,
            vy: (Math.random() - 0.5) * 15 - 10,
            color: colors[Math.floor(Math.random() * colors.length)],
            size: Math.random() * 6 + 3,
            rotation: Math.random() * 360,
            rotationSpeed: (Math.random() - 0.5) * 10
        });
    }
    
    let frame = 0;
    const maxFrames = 100;
    
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        particles.forEach(p => {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.4;
            p.rotation += p.rotationSpeed;
            
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rotation * Math.PI / 180);
            ctx.fillStyle = p.color;
            ctx.globalAlpha = 1 - (frame / maxFrames);
            ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
            ctx.restore();
        });
        
        frame++;
        if (frame < maxFrames) {
            requestAnimationFrame(animate);
        } else {
            canvas.style.display = 'none';
        }
    }
    
    animate();
}

// ============ TOAST ============
function showToast(message, type = 'info') {
    let container = document.getElementById('toasts');
    if (!container) {
        container = create('div', 'toast-container', document.body);
        container.id = 'toasts';
    }
    
    const toast = create('div', `toast ${type}`, container);
    toast.textContent = message;
    
    setTimeout(() => {
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ============ MODALS ============
function showAboutModal() {
    const existing = $('.modal-overlay');
    if (existing) existing.remove();
    
    const overlay = create('div', 'modal-overlay', document.body);
    overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
    
    const modal = create('div', 'modal', overlay);
    modal.innerHTML = `
        <div class="modal-header">
            <div class="modal-logo">üåô</div>
            <h2 class="modal-title">${t('aboutTitle')}</h2>
        </div>
        <p class="modal-body">${t('aboutText')}</p>
        <button class="modal-close-btn" onclick="this.closest('.modal-overlay').remove()">
            ${t('close')}
        </button>
    `;
    
    if (window.innerWidth <= 768) toggleSidebar(false);
}

// ============ TEST API ============
async function testAPI() {
    console.log('üß™ Testing OpenRouter API...');
    try {
        const response = await fetch('https://openrouter.ai/api/v1/models', {
            headers: {
                'Authorization': `Bearer ${OPENROUTER_API_KEY}`
            }
        });
        const data = await response.json();
        console.log('‚úÖ API Key is valid! Available models:', data.data?.length || 0);
        
        // –ù–∞–π–¥—ë–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏
        const freeModels = data.data?.filter(m => m.id.includes(':free')) || [];
        console.log('üÜì Free models available:', freeModels.map(m => m.id));
        
        if (freeModels.length > 0) {
            // –û–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
            window.WORKING_FREE_MODELS = freeModels.map(m => m.id);
            console.log('‚úÖ Working free models:', window.WORKING_FREE_MODELS);
        }
        
        return true;
    } catch (err) {
        console.error('‚ùå API test failed:', err);
        return false;
    }
}

// ============ INIT ============
document.addEventListener('DOMContentLoaded', async () => {
    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —á–∞—Ç—ã —Å –æ—à–∏–±–∫–∞–º–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const version = localStorage.getItem('photonnai-version');
    if (version !== 'v2.1') {
        // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ—à–∏–±–∫–∞–º–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        chats.forEach(chat => {
            chat.messages = chat.messages.filter(m => 
                !m.content.includes('—Å–µ—Ä–≤–µ—Ä—ã –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω—ã') &&
                !m.content.includes('Servers are busy') &&
                !m.content.includes('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞')
            );
        });
        // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ —á–∞—Ç—ã
        chats = chats.filter(c => c.messages.length > 0);
        if (chats.length === 0) currentChatId = null;
        saveChats();
        localStorage.setItem('photonnai-version', 'v2.1');
        console.log('üßπ Cleaned up old error messages');
    }
    
    buildUI();
    await testAPI();
});

window.addEventListener('resize', () => {
    if (window.innerWidth > 768 && !isSidebarOpen) {
        isSidebarOpen = true;
        updateSidebarState();
    }
});
    </script>
</body>
</html>
